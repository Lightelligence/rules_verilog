#!/usr/bin/env bash

cd {{ bazel_runfiles_main }} && \
  runmod -t {{ options.simulator }} -- \
    {% if options.simulator == 'xrun' -%}
      -xmlibdirname {{ VCOMP_DIR }} \
      {% for define in additional_defines -%}
        -define {{ define }} \
      {% endfor -%}
      {% if options.xprof -%}
        -xprof \
      {% endif -%}
    {% endif -%}
    {% if options.simulator == 'vcs' -%}
      -full64 +v2k +vpi -notice -licqueue \
      -V -DVCS -CFLAGS -LDFLAGS -assert svaext \
      {% if enable_debug_access == 0 -%}
        -debug_access+pp \
      {% endif -%}
        -partcomp -pcmakeprof -j4 -reportstats \
        -lca -lrt -simprofile time \
        -ntb_opts uvm-1.2 \
        +lint=PCWM-L,TFIPC-L,PCWM \
        -xlrm floating_pnt_constraint \
        -xlrm uniq_prior_final \
        -Mdir={{ VCOMP_DIR }}/csrc \
        -Mlib={{ VCOMP_DIR }}/csrc \
        +libext+.sv+.svh+.v+.vams \
        +systemverilogext+.sv+.svh \
        -timescale=1ns/1ns \
      {% for define in additional_defines -%}
        +define+{{ define }} \
      {% endfor -%}
      -o {{ VCOMP_DIR }}/simv \
    {% endif -%}
    {% if xprop_cmd is not none -%}
      {{ xprop_cmd }} \
    {% endif -%}
    {% if enable_debug_access > 0 -%}
      {% if options.simulator == 'xrun' -%}
        +vpiSyncPerf \
        -createdebugdb \
        -debug_opts verisium_pp \
      {% endif -%}
      {% if options.simulator == 'vcs' -%}
        -kdb \
        -debug_region=cell+lib \
        -debug_access+all+designer+simctrl \
        +define+UVM_VERDI_COMPWAVE \
      {% endif -%}
    {% endif -%}
    {% if enable_debug_access > 1 -%}
      +fsmdebug \
      -linedebug \
      -uvmlinedebug \
    {% endif -%}
    {% if cov_opts is not none -%}
      {{ cov_opts }} \
    {% endif -%}
    -f {{ bazel_compile_args }} \
    -l {{ VCOMP_DIR }}/cmp.log \

